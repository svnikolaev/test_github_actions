import json
import unittest
from datetime import datetime

from services.a_current_unauth_waste_sites.service import count_states
from services.b_covid_statistic.service import prepare_message_text


class TestServices(unittest.TestCase):
    def test_count_states(self):
        data = json.loads(r'[{"EntityAlias":"SafeUnauthWasteDisposalSiteActing","EntityKey":1000010005068016,"Fields":{"SafeDateFixFact":"2022-02-03T00:00:00","WasteSizeFactNum":null,"StatusCheck":1000010003645659.0,"Initiator":1000010003638949.0,"WasteSizeFact":null,"SafeDateFixPlan":null,"WasteType":null,"WasteSize":1000010003645998.0,"Wasted":null,"SafePlace":"—É–ª. –•–ª–µ–±–Ω–∞—è, 15","Id":5.0,"Note":null,"InformationOnFines":null,"Latitude":null,"Longitude":null,"SafeDateFix":"2022-03-05T12:44:22.999333","DateFixation":"2022-02-01T00:00:00","St":1000010004586012.0,"Implementor":1000010003646126.0,"Status":1000010003640069.0,"MunicipalUnit":1000010000342019.0,"Owner":null,"FractionalComposition":null,"Area":null,"UserUpdateField":1000010003645895.0,"UserInsertField":1000010003644379.0,"InfoSetKey":null,"KeyField":1000010005068016.0,"FullNameField":"–ú–ù–†–û 5 –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ","DateUpdateField":"2022-02-03T16:35:07.052732","DateInsertField":"2022-02-03T12:44:22.999333","Project":"–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","File":[{"EntityAlias":"File","EntityKey":1000010005068021},{"EntityAlias":"File","EntityKey":1000010005068022},{"EntityAlias":"File","EntityKey":1000010005068023},{"EntityAlias":"File","EntityKey":1000010005068024},{"EntityAlias":"File","EntityKey":1000010005068025},{"EntityAlias":"File","EntityKey":1000010005068026},{"EntityAlias":"File","EntityKey":1000010005068027}]}},{"EntityAlias":"SafeUnauthWasteDisposalSiteActing","EntityKey":1000010005060731,"Fields":{"SafeDateFixFact":"2022-01-19T00:00:00","WasteSizeFactNum":null,"StatusCheck":1000010003645659.0,"Initiator":1000010003638949.0,"WasteSizeFact":null,"SafeDateFixPlan":null,"WasteType":null,"WasteSize":1000010003645998.0,"Wasted":null,"SafePlace":"–ø–µ—Ä. –ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π, 26","Id":2.0,"Note":null,"InformationOnFines":null,"Latitude":null,"Longitude":null,"SafeDateFix":"2022-02-27T10:40:38.179406","DateFixation":"2022-01-17T00:00:00","St":1000010004586012.0,"Implementor":1000010003646126.0,"Status":1000010003640069.0,"MunicipalUnit":1000010000342019.0,"Owner":null,"FractionalComposition":null,"Area":null,"UserUpdateField":1000010003645895.0,"UserInsertField":1000010003644379.0,"InfoSetKey":null,"KeyField":1000010005060731.0,"FullNameField":"–ú–ù–†–û 2 –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ","DateUpdateField":"2022-02-01T09:06:50.094643","DateInsertField":"2022-01-28T10:40:38.179406","Project":"–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","File":[{"EntityAlias":"File","EntityKey":1000010005060733},{"EntityAlias":"File","EntityKey":1000010005060734}]}},{"EntityAlias":"SafeUnauthWasteDisposalSiteActing","EntityKey":1000010005060748,"Fields":{"SafeDateFixFact":"2022-01-19T00:00:00","WasteSizeFactNum":null,"StatusCheck":1000010003645659.0,"Initiator":1000010003638949.0,"WasteSizeFact":null,"SafeDateFixPlan":null,"WasteType":null,"WasteSize":1000010003645998.0,"Wasted":null,"SafePlace":"–°–ù–¢ \"–û–±—â–µ–ø–∏—Ç–æ–≤–µ—Ü\" 46.960126, 142.687098","Id":4.0,"Note":null,"InformationOnFines":null,"Latitude":null,"Longitude":null,"SafeDateFix":"2022-02-27T10:51:26.162822","DateFixation":"2022-01-17T00:00:00","St":1000010004586012.0,"Implementor":1000010003646126.0,"Status":1000010003640069.0,"MunicipalUnit":1000010000342019.0,"Owner":null,"FractionalComposition":null,"Area":null,"UserUpdateField":1000010003645895.0,"UserInsertField":1000010003644379.0,"InfoSetKey":null,"KeyField":1000010005060748.0,"FullNameField":"–ú–ù–†–û 4 –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ","DateUpdateField":"2022-02-01T09:06:43.00233","DateInsertField":"2022-01-28T10:51:26.162822","Project":"–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","File":[{"EntityAlias":"File","EntityKey":1000010005060750},{"EntityAlias":"File","EntityKey":1000010005060751},{"EntityAlias":"File","EntityKey":1000010005060752}]}},{"EntityAlias":"SafeUnauthWasteDisposalSiteActing","EntityKey":1000010005060739,"Fields":{"SafeDateFixFact":"2022-01-19T00:00:00","WasteSizeFactNum":null,"StatusCheck":1000010003645659.0,"Initiator":1000010003638949.0,"WasteSizeFact":null,"SafeDateFixPlan":null,"WasteType":null,"WasteSize":1000010003645998.0,"Wasted":null,"SafePlace":"—É–ª. –õ–µ—Ä–º–æ–Ω—Ç–æ–≤–∞, 26","Id":3.0,"Note":null,"InformationOnFines":null,"Latitude":null,"Longitude":null,"SafeDateFix":"2022-02-27T10:45:56.261287","DateFixation":"2022-01-17T00:00:00","St":1000010004586012.0,"Implementor":1000010003646126.0,"Status":1000010003640069.0,"MunicipalUnit":1000010000342019.0,"Owner":null,"FractionalComposition":null,"Area":null,"UserUpdateField":1000010003645895.0,"UserInsertField":1000010003644379.0,"InfoSetKey":null,"KeyField":1000010005060739.0,"FullNameField":"–ú–ù–†–û 3 –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ","DateUpdateField":"2022-02-01T09:06:37.989618","DateInsertField":"2022-01-28T10:45:56.261287","Project":"–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","File":[{"EntityAlias":"File","EntityKey":1000010005060744},{"EntityAlias":"File","EntityKey":1000010005060745}]}},{"EntityAlias":"SafeUnauthWasteDisposalSiteActing","EntityKey":1000010005060723,"Fields":{"SafeDateFixFact":"2022-01-19T00:00:00","WasteSizeFactNum":null,"StatusCheck":1000010003645659.0,"Initiator":1000010003638949.0,"WasteSizeFact":null,"SafeDateFixPlan":null,"WasteType":null,"WasteSize":1000010003645998.0,"Wasted":null,"SafePlace":"—É–ª. –ì–∞—Ä–∞–∂–Ω–∞—è 46.977419, 142.720428","Id":1.0,"Note":null,"InformationOnFines":null,"Latitude":null,"Longitude":null,"SafeDateFix":"2022-02-27T10:32:02.852718","DateFixation":"2022-01-17T00:00:00","St":1000010004586012.0,"Implementor":1000010003646126.0,"Status":1000010003640069.0,"MunicipalUnit":1000010000342019.0,"Owner":null,"FractionalComposition":null,"Area":null,"UserUpdateField":1000010003645895.0,"UserInsertField":1000010003644379.0,"InfoSetKey":null,"KeyField":1000010005060723.0,"FullNameField":"–ú–ù–†–û 1 –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ","DateUpdateField":"2022-02-01T09:06:32.632818","DateInsertField":"2022-01-28T10:32:02.852718","Project":"–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å","File":[{"EntityAlias":"File","EntityKey":1000010005060727},{"EntityAlias":"File","EntityKey":1000010005060728}]}}]')
        self.assertEqual(
            count_states(data),
            {'–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è': 0, '–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Å –Ω–∞—á–∞–ª–∞ –≥–æ–¥–∞': 5, '–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ': 5, '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ': 5, '–í —Ä–∞–±–æ—Ç–µ': 0, '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ': {'–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ': 0, '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ': 0, '–í —Ä–∞–±–æ—Ç–µ': 0}}
        )

    def test_prepare_message_text(self):
        self.assertEqual(
            prepare_message_text(
                {'operators_per_shift': 4, 'day': 2, 'night': 2, 'number_of_covid_calls': 342, 'average_talk_time': 3.3, 'maximum_waiting_time': 7.2, 'average_waiting_time': 1, 'waiting_more_than_3_minutes': 1, 'switch_to_doctor': 100, 'doctors_appointments': 0, 'registration_for_tests': 0, 'doctor_call': 0, 'ambulance_call': 0, 'volunteer_call': 0, 'other': 0, 'number_of_no_answered_calls': 19, 'covid_directions': 0, 'date': datetime(2022, 2, 6, 12, 17, 49, 95515)},
                'testuser'
            ),
            'ü¶† *–î–∞–Ω–Ω—ã–µ –ø–æ –∑–≤–æ–Ω–∫–∞–º Covid-19 –∑–∞ 06.02.2022:*\nüîµ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–æ–Ω–∫–æ–≤: 342 (—à—Ç.)\nüî¥ –ù–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã: 19 (—à—Ç.)\nüî¥ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è: 7.2 (–º–∏–Ω.)\n@testuser –í–ù–ò–ú–ê–ù–ò–ï! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –±–æ–ª—å—à–µ 3—Ö –º–∏–Ω—É—Ç'
        )

if __name__ == '__main__':
    unittest.main()
# flake8: noqa